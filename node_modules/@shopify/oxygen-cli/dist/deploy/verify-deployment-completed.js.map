{"version":3,"sources":["../../src/deploy/verify-deployment-completed.ts"],"names":[],"mappings":"AAAA,SAAQ,sBAAqB;AAC7B;AAAA,EAEE;AAAA,EACA;AAAA,OACK;AAEP,SAAQ,cAAa;AAErB;AAAA,EAGE;AAAA,OACK;AACP;AAAA,EACE;AAAA,EAGA;AAAA,OACK;AASP,eAAsB,0BACpB,SACA,cACgD;AAChD,QAAM,EAAC,QAAQ,QAAQ,kBAAkB,MAAK,IAAI;AAClD,QAAM,YAAY;AAAA,IAChB;AAAA,EACF;AAEA,SAAO,yCAAyC;AAChD,aAAW,qCAAqC,MAAM;AAEtD,MAAI,WAAW;AACf,QAAM,YAAY,KAAK,IAAI;AAE3B,QAAM,iBAAiB,YAAY;AACjC,UAAM,QAAQ;AACd,UAAM,eAAe,KAAK,IAAI,IAAI,aAAa;AAC/C,QAAI,cAAc,QAAQ,MAAO,kBAAkB;AACjD,aAAO,yCAAyC;AAChD,YAAM,IAAI;AAAA,QACR,kCAAkC,gBAAgB;AAAA,MACpD;AAAA,IACF;AACA;AACA,UAAM,IAAI,QAAQ,CAAC,YAAY,WAAW,SAAS,KAAK,CAAC;AACzD,WAAO,MAAM;AAAA,EACf;AAEA,QAAM,QAAQ,YAA4D;AACxE,UAAM,WACJ,MAAM,eAAe;AAAA,MACnB,OAAO;AAAA,MACP,KAAK;AAAA,MACL,KAAK,GAAG,OAAO,aAAa;AAAA,MAC5B,OAAO,OAAO,gBAAgB;AAAA,MAC9B;AAAA,MACA,cAAc;AAAA,QACZ,CAAC,OAAO,qBAAqB,GAAG,OAAO,gBAAgB;AAAA,MACzD;AAAA,IACF,CAAC;AAEH,UAAM,OAAO,SAAS;AACtB,QAAI,QAAQ,MAAM;AAChB,aAAO,yCAAyC;AAChD,YAAM,IAAI,qCAAqC,sBAAsB;AAAA,IACvE;AAEA,QAAI,KAAK,WAAW,OAAO,UAAU;AACnC,sBAAgB,+CAA+C,MAAM;AACrE,aAAO,wBAAwB;AAC/B,aAAO;AAAA,IACT;AAEA,QAAI,KAAK,WAAW,OAAO,UAAU,KAAK,WAAW,OAAO,WAAW;AACrE,aAAO,qBAAqB,IAAI;AAChC,YAAM,IAAI;AAAA,QACR,KAAK,QACD,cAAc,KAAK,OAAO,kBAAkB,CAAC,YAC3C,KAAK,KACP,KACA,cAAc,KAAK,OAAO,kBAAkB,CAAC;AAAA,MACnD;AAAA,IACF;AAEA,WAAO,eAAe;AAAA,EACxB;AAEA,SAAO,MAAM;AACf","sourcesContent":["import {graphqlRequest} from '@shopify/cli-kit/node/api/graphql';\nimport {\n  Logger,\n  outputCompleted,\n  outputInfo,\n} from '@shopify/cli-kit/node/output';\n\nimport {Header} from '../utils/utils.js';\n\nimport {\n  DeploymentConfig,\n  DeploymentHooks,\n  DeploymentCompletedVerificationError,\n} from './types.js';\nimport {\n  DeploymentVerificationDetailsQuery,\n  DeploymentVerificationDetailsQueryData,\n  DeploymentVerificationDetailsResponse,\n  Status,\n} from './graphql/deployment-verification-details.js';\n\ninterface DeploymentVerificationDetailsOptions {\n  config: DeploymentConfig;\n  hooks?: DeploymentHooks;\n  timeoutInSeconds: number;\n  logger: Logger;\n}\n\nexport async function verifyDeploymentCompleted(\n  options: DeploymentVerificationDetailsOptions,\n  deploymentId: string,\n): Promise<DeploymentVerificationDetailsResponse> {\n  const {config, logger, timeoutInSeconds, hooks} = options;\n  const variables = {\n    deploymentId,\n  };\n\n  hooks?.onDeploymentCompletedVerificationStart?.();\n  outputInfo('Verifying deployment completed...', logger);\n\n  let attempts = 0;\n  const startTime = Date.now();\n\n  const handleInterval = async () => {\n    const delay = 3000;\n    const elapsedTime = (Date.now() - startTime) / 1000;\n    if (elapsedTime + delay / 1000 > timeoutInSeconds) {\n      hooks?.onDeploymentCompletedVerificationError?.();\n      throw new Error(\n        `Deployment not completed after ${timeoutInSeconds} seconds.`,\n      );\n    }\n    attempts++;\n    await new Promise((resolve) => setTimeout(resolve, delay));\n    return check();\n  };\n\n  const check = async (): Promise<DeploymentVerificationDetailsResponse> => {\n    const response: DeploymentVerificationDetailsQueryData =\n      await graphqlRequest({\n        query: DeploymentVerificationDetailsQuery,\n        api: 'Oxygen',\n        url: `${config.deploymentUrl}/api/v2/admin/graphql`,\n        token: config.deploymentToken.accessToken,\n        variables,\n        addedHeaders: {\n          [Header.OxygenNamespaceHandle]: config.deploymentToken.namespace,\n        },\n      });\n\n    const data = response.deploymentVerificationDetails;\n    if (data == null) {\n      hooks?.onDeploymentCompletedVerificationError?.();\n      throw new DeploymentCompletedVerificationError('Deployment not found');\n    }\n\n    if (data.status === Status.Deployed) {\n      outputCompleted('Deployment to Oxygen completed successfully', logger);\n      hooks?.onDeploymentCompleted?.();\n      return data;\n    }\n\n    if (data.status === Status.Failed || data.status === Status.Cancelled) {\n      hooks?.onDeploymentFailed?.(data);\n      throw new DeploymentCompletedVerificationError(\n        data.error\n          ? `Deployment ${data.status.toLocaleLowerCase()}, error: ${\n              data.error\n            }`\n          : `Deployment ${data.status.toLocaleLowerCase()}`,\n      );\n    }\n\n    return handleInterval();\n  };\n\n  return check();\n}\n"]}